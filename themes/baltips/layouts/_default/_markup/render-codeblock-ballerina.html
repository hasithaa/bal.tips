{{ if .Options }}
    {{ errorf "Ballerina code fence does not support options. Use lines Attribute instead." }}
{{ end }}
{{ if not (isset .Attributes "filename") }}
    {{ errorf "Ballerina code fence requires filename attribute."}}
{{ else }}
    {{ $filename := index .Attributes "filename"}}
    {{ $options := print "style=manni,lineNos=table,anchorLineNos=true,lineAnchors=full-" $filename}}
    {{ with index .Attributes "lines" }}
        {{ $options = print $options ",hl_lines=" .  }}
    {{ end }}

    {{ $code := .Inner }}
    {{ $code = split $code "\n" }}

    {{ $fullView := slice }}
    {{ $simpleView := slice }}
    {{ $highlightView := slice }}

    {{ $simpleView = $simpleView | append "// Partial Code. Change View $CHANGE$ to see full code." }}
    {{ $highlightView = $highlightView | append "// Highlights Only. Change View $CHANGE$ to see full code." }}
    {{ range $code  }}
        {{ if strings.Contains . "//$"  }}
            {{ $oline := split . "//$"  }}
            {{ $line := (strings.TrimRight " " (index $oline 0)) }}
            {{ $fullView = $fullView | append $line  }}
            {{ $simpleView = $simpleView | append $line }}
            {{ $highlightView = $highlightView | append (strings.TrimLeft " " $line)  }}
        {{ else if strings.Contains . "//!" }}
            {{ $line := split . "//!" }}
            {{ $line := (strings.TrimRight " " (index $line 0)) }}
            {{ $fullView = $fullView | append $line  }}
        {{ else }}
            {{ $line :=  . }}
            {{ $fullView = $fullView | append $line  }}
            {{ $simpleView = $simpleView | append $line  }}
        {{ end }}
    {{ end }}

    {{ $baseURL := replace .Page.File.Dir "\\" "/"  }}
    {{ $sourceFilePath := printf "%s%s" $baseURL $filename }}
    {{ $codeURL := (printf "%s" $sourceFilePath ) | relLangURL }}
    {{ $codeOut := "" }}
    {{ if eq "output" (index .Attributes "result")}}
        {{ $codeOut = highlight (readFile (print $sourceFilePath ".out")) "BashSession" "style=manni" -}} 
    {{ end }}

  
<div class="tip-code-full d-none table-responsive rounded rounded-3 shadow-3 m-auto text-dark col-lg-9 col-12 bg-code ">
    {{ $fullView = delimit $fullView "\n" }}
    <div class="p-2">{{ highlight $fullView "ballerina" $options }}</div>
    <a class="link px-2" data-mdb-toggle="collapse" data-mdb-target="#collapsibleDiv" aria-expanded="false" aria-controls="collapsibleDiv">
        &nbsp;$&nbsp;<code>bal run&nbsp;{{- $filename -}}</code>
    </a>
    <div class="collapse p-2" id="collapsibleDiv">
        {{- $codeOut -}}
    </div>
</div>

<div class="tip-code-simple d-none table-responsive rounded rounded-3 shadow-3 m-auto text-dark col-lg-9 col-12 bg-code ">
    {{ $simpleView = delimit $simpleView "\n" }}    
    {{ $codeContent := highlight $simpleView "ballerina" (print "style=manni") }}
    {{ $codeContent = (replace $codeContent "$SOURCE$" (print "<a href='" $codeURL "' target='_blank'>" $filename "</a>")) }}
    {{ $codeContent = (replace $codeContent "$CHANGE$"  (print "<a href='#offcanvasRight' data-mdb-toggle='offcanvas' data-mdb-target='#offcanvasRight' aria-controls='offcanvasRight' ><i class='bi bi-sliders'></i></a>")) }}
    <div class="p-2 overflow-auto">{{ safeHTML $codeContent}}</div>
</div>

<div class="tip-code-highlight d-none table-responsive rounded rounded-3 shadow-3 m-auto text-dark col-lg-6 col-12 bg-code ">
    {{ $highlightView = delimit $highlightView "\n" }}
    {{ $codeContent := highlight $highlightView "ballerina" (print "style=manni") }}
    {{ $codeContent = (replace $codeContent "$SOURCE$" (print "<a href='" $codeURL "' target='_blank'>" $filename "</a>")) }}
    {{ $codeContent = (replace $codeContent "$CHANGE$"  (print "<a href='#offcanvasRight' data-mdb-toggle='offcanvas' data-mdb-target='#offcanvasRight' aria-controls='offcanvasRight' ><i class='bi bi-sliders'></i></a>")) }}
    <div class="p-2 overflow-auto">{{ safeHTML $codeContent}}</div>
</div>

{{ end }}
